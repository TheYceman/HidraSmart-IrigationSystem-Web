<%- include('../components/common/head.ejs', { pageTitle: pageTitle }) %>
  <link rel="stylesheet" href="/styles/navbar.css">
  <link rel="stylesheet" href="/styles/socialbar.css">
  <script src="/scripts/navbar.js" defer></script>

  <link rel="stylesheet" href="/styles/gestor_usuarios.css">
  <script src="/scripts/gestor-usuarios.js" defer></script>
  <script src="/scripts/gestor-roles.js" defer></script>
  </head>

  <body>
    <header>
      <%- include('../components/common/navbar.ejs') %>
    </header>
    <main>
      <h2 class="titulo_seccion">
      </h2>
      <div class="tab-labels">
        <div class="tab-label active" data-tab="tabla1" onclick="showTab('tabla1')">Usuarios</div>
        <div class="tab-label" data-tab="tabla2" onclick="showTab('tabla2')">Grupos de usuario</div>
        <!-- Agrega más pestañas según sea necesario -->
      </div>
      <!-- Contenido de las pestañas -->
      <div class="tab-content active" id="tabla1">
        <div class="div-container">
          <button id="mostrarFormUsuarios" class="btn">Añadir nuevo usuario</button>
          <form action="/gestor-usuarios/agregarUsuario" method="POST" id="usuariosForm" style="display: none;">
            <label for="Login">Login:</label>
            <input type="text" name="login" required>
            <label for="Nombre">Nombre:</label>
            <input type="text" name="name" id="name" required>
            <label for="Apellidos">Apellidos:</label>
            <input type="text" name="surname" id="surname" required>
            <label for="Grupo">Rol:</label>
            <input type="text" name="rol" id="rol" required>
            <label for="Email">Email:</label>
            <input type="text" name="email" id="email" required>
            <label for="Phone">Phone:</label>
            <input type="text" name="phone" id="phone" required>
            <button type="submit" class="btn">Añadir</button>
          </form>
          <label>Buscar registro... </label><input type="text" id="search" class="search-input" placeholder="Buscar">
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Rol</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="table">
              <% for(let usuario of usuarios) { %>
                <tr data-uid="<%= usuario.login %>">
                  <td data-field="login" data-id="<%= usuario.idusers %>">
                    <%= usuario.idusers %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="nombre" data-id="<%= usuario.idusers %>">
                    <%= usuario.name %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="apellido" data-id="<%= usuario.idusers %>">
                    <%= usuario.surname %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="grupo" data-id="<%= usuario.idusers %>">
                    <%= usuario.rol %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="email" data-id="<%= usuario.idusers %>">
                    <%= usuario.email %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="phone" data-id="<%= usuario.idusers %>">
                    <%= usuario.phone %>
                  </td>
                  <td class="acciones">
                    <button class="btn" onclick="updateUsuario('<%= usuario.idusers %>')">Actualizar</button>
                    <button class="btn red-btn" onclick="borrarUsuario('<%= usuario.idusers %>')">Borrar</button>
                  </td>
                </tr>
                <% } %>
            </tbody>
          </table>
        </div>
        <script> var todos = [];</script>
        <% for(let usuario of todosLosUsuarios) { %>
          <script>
            todos.push({ id: '<%= usuario.idusers %>', password: '<%= usuario.password %>' });
            //console.log(todos);
          </script>
          <% } %>
            <div class="div-container">
              <!-- Botones de paginación -->
              <!-- 
         
        -->
              <div class="pagination">
                <label for="page-selector">Página:</label>
                <select id="page-selector" onchange="window.location.href = '/gestor-usuarios?page=' + this.value;">
                  <% for (let i=1; i <=totalPages; i++) { %>
                    <option value="<%= i %>" <%=i===currentPage ? 'selected' : '' %>><%= i %>
                    </option>
                    <% } %>
                </select>
              </div>
            </div>
      </div>

      <div class="tab-content" id="tabla2">
        <div class="div-container">
          <button id="mostrarFormRoles" class="btn">Añadir nuevo rol</button>
          <form action="/gestor-usuarios/agregarRoles" method="POST" id="rolesForm" style="display: none;">
            <label for="Usuarios">Usuarios:</label>
            <input type="text" name="perUsu" id="perUsu" required>
            <label for="Visor">Visor:</label>
            <input type="text" name="perVisor" id="perVisor" required>
            <label for="Meteorológicos">Meteorológicos:</label>
            <input type="text" name="perMeteo" id="perMeteo" required>
            <label for="Red">Red:</label>
            <input type="text" name="perRed" id="perRed" required>
            <label for="Demandas">Demandas:</label>
            <input type="text" name="perDemandas" id="perDemandas" required>
            <label for="Riego">Riego:</label>
            <input type="text" name="perRiego" id="perRiego" required>
            <button type="submit" class="btn">Añadir</button>
          </form>
          <label>Buscar registro... </label><input type="text" id="search" class="search-input" placeholder="Buscar">
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Usuarios</th>
                <th>Visor</th>
                <th>Meteorológicos</th>
                <th>Red</th>
                <th>Demandas</th>
                <th>Riego</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="table">
              <% for(let rol of roles) { %>
                <tr data-uid="<%= rol.nombre %>">
                  <td data-field="login" data-id="<%= rol.nombre %>">
                    <%= rol.nombre %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perUsu" data-id="<%= rol.nombre %>">
                    <%= rol.perUsu %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perVisor" data-id="<%= rol.nombre %>">
                    <%= rol.perVisor %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perMeteo" data-id="<%= rol.nombre %>">
                    <%= rol.perMeteo %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perRed" data-id="<%= rol.nombre %>">
                    <%= rol.perRed %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perDemandas" data-id="<%= rol.nombre %>">
                    <%= rol.perDemandas %>
                  </td>
                  <td contenteditable="true" class="editable" data-field="perRiego" data-id="<%= rol.nombre %>">
                    <%= rol.perRiego %>
                  </td>
                  <td class="acciones">
                    <button class="btn" onclick="updateRol('<%= rol.nombre %>')">Actualizar</button>
                    <button class="btn red-btn" onclick="borrarRol('<%= rol.nombre %>')">Borrar</button>
                  </td>
                </tr>
                <% } %>
            </tbody>
          </table>
        </div>
        <script> var todos = [];</script>
        <% for(let rol of todosLosRoles) { %>
          <script>
            todos.push({ id: '<%= rol.nombre %>'});
            //console.log(todos);
          </script>
          <% } %>
            <div class="div-container">
              <!-- Botones de paginación -->
              <!-- 
             
            -->
              <div class="pagination">
                <label for="page-selector">Página:</label>
                <select id="page-selector" onchange="window.location.href = '/gestor-usuarios?pageRoles=' + this.value;">
                  <% for (let i=1; i <=totalPagesRoles; i++) { %>
                    <option value="<%= i %>" <%=i===currentPageRoles ? 'selected' : '' %>><%= i %>
                    </option>
                    <% } %>
                </select>
              </div>
            </div>
      </div>
      <%- include('../components/common/footer.ejs') %>
    </main>
    <script>
      const mostrarFormularioButton = document.getElementById('mostrarFormUsuarios');
      const miFormulario = document.getElementById('usuariosForm');

      mostrarFormularioButton.addEventListener('click', () => {
        // Cambia la visibilidad del formulario cuando se hace clic en el botón
        if (miFormulario.style.display === 'none') {
          miFormulario.style.display = 'block';
        } else {
          miFormulario.style.display = 'none';
        }
      });

      const mostrarFormularioRolesButton = document.getElementById('mostrarFormRoles');
      const miFormularioRoles = document.getElementById('rolesForm');

      mostrarFormularioRolesButton.addEventListener('click', () => {
        // Cambia la visibilidad del formulario cuando se hace clic en el botón
        if (miFormularioRoles.style.display === 'none') {
          miFormularioRoles.style.display = 'block';
        } else {
          miFormularioRoles.style.display = 'none';
        }
      });
    </script>

    <!-- Script para la búsqueda en tiempo real -->
    <script>
      //Solo busca en la página actual
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("search");

        searchInput.addEventListener("keyup", function () {
          const searchTerm = this.value.toLowerCase();

          // Accede a la variable de Node.js (miVariable) y asígnala a una variable de JavaScript

          console.log("todos " + todos[0].id);

          var found = false;
          for (var i = 0; i < todos.length; i++) {
            //console.log("contador['id'] " + todos[i].id + " " + searchTerm);
            if ((todos[i].login.toLowerCase()).includes(searchTerm)) {
              found = true;
              break;
            }

          }
          if (found) {
            var pagina = (i / 10) + 1;
            console.log("Página: " + parseInt(pagina));
            location.href = "/gestor-usuarios?page=" + parseInt(pagina);
            //row.style.display = "";
          } else {
            //row.style.display = "none";
          }

        });
      });
    </script>
    <script>
      // Función para mostrar la pestaña seleccionada
      function showTab(tabId) {
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');

        const tabLabels = document.querySelectorAll('.tab-label');
        tabLabels.forEach(label => label.classList.remove('active'));
        const activeLabel = document.querySelector(`.tab-label[data-tab="${tabId}"]`);
        activeLabel.classList.add('active');
      }
    </script>

  </body>