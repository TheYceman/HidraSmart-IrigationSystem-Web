<%- include('../components/common/head.ejs', { pageTitle: pageTitle }) %>
  <link rel="stylesheet" href="/styles/navbar.css">
  <link rel="stylesheet" href="/styles/socialbar.css">
  <script src="/scripts/navbar.js" defer></script>

  <link rel="stylesheet" href="/styles/gestor_usuarios.css">
  <script src="/scripts/gestor-usuarios.js" defer></script>
  </head>

  <body>
    <header>
        <%- include('../components/common/navbar.ejs') %>
    </header>
    <main>
      <h2 class="titulo_seccion">
        <p>Gestor de Usuarios</p>
      </h2>
      <div class="div-container">
        <button id="mostrarFormUsuarios" class="btn">Añadir nuevo usuario</button>
        <form action="/gestor-usuarios/agregarUsuario" method="POST" id="usuariosForm" style="display: none;">
          <label for="Login">Login:</label>
          <input type="text" name="login" required>
          <label for="Nombre">Nombre:</label>
          <input type="text" name="nombre" id="nombre" required>
          <label for="Apellidos">Apellidos:</label>
          <input type="text" name="apellido" id="apellido" required>
          <label for="Grupo">Grupo:</label>
          <input type="text" name="grupo" id="grupo" required>
          <label for="Email">Email:</label>
          <input type="text" name="email" id="email" required>
          <label for="Phone">Phone:</label>
          <input type="text" name="phone" id="phone" required>
          <button type="submit" class="btn">Añadir</button>
        </form>
        <label>Buscar registro... </label><input type="text" id="search" class="search-input" placeholder="Buscar">
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Nombre</th>
              <th>Apellidos</th>
              <th>Grupo</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="table">
            <% for(let usuario of usuarios) { %>
              <tr data-uid="<%= usuario.idusers %>">
                <td data-field="login" data-id="<%= usuario.idusers %>">
                  <%= usuario.username %>
                </td>
                <td contenteditable="true" class="editable" data-field="nombre" data-id="<%= usuario.idusers %>">
                  <%= usuario.name %>
                </td>
                <td contenteditable="true" class="editable" data-field="apellido" data-id="<%= usuario.idusers %>">
                  <%= usuario.surname %>
                </td>
                <td contenteditable="true" class="editable" data-field="grupo" data-id="<%= usuario.idusers %>">
                  <%= usuario.rol %>
                </td>
                <td contenteditable="true" class="editable" data-field="email" data-id="<%= usuario.idusers %>">
                  <%= usuario.email %>
                </td>
                <td contenteditable="true" class="editable" data-field="phone" data-id="<%= usuario.idusers %>">
                  <%= usuario.phone %>
                </td>
                <td class="acciones">
                  <button class="btn" onclick="updateUsuario('<%= usuario.login %>')">Actualizar</button>
                  <button class="btn red-btn" onclick="borrarUsuario('<%= usuario.login %>')">Borrar</button>
                </td>
              </tr>
              <% } %>
          </tbody>
        </table>
      </div>
      <script> var todos = [];</script>
      <% for(let usuario of todosLosUsuarios) { %>
        <script>
          todos.push({ id: '<%= usuario.login %>', password: '<%= usuario.password %>' });
          //console.log(todos);
        </script>
        <% } %>
          <div class="div-container">
            <!-- Botones de paginación -->
            <!-- 
         
        -->
            <div class="pagination">
              <label for="page-selector">Página:</label>
              <select id="page-selector" onchange="window.location.href = '/gestor-usuarios?page=' + this.value;">
                <% for (let i=1; i <=totalPages; i++) { %>
                  <option value="<%= i %>" <%=i===currentPage ? 'selected' : '' %>><%= i %>
                  </option>
                  <% } %>
              </select>
            </div>


          </div>
          <%- include('../components/common/footer.ejs') %>
    </main>
    <script>
      const mostrarFormularioButton = document.getElementById('mostrarFormUsuarios');
      const miFormulario = document.getElementById('usuariosForm');

      mostrarFormularioButton.addEventListener('click', () => {
        // Cambia la visibilidad del formulario cuando se hace clic en el botón
        if (miFormulario.style.display === 'none') {
          miFormulario.style.display = 'block';
        } else {
          miFormulario.style.display = 'none';
        }
      });
    </script>

    <!-- Script para la búsqueda en tiempo real -->
    <script>
      //Solo busca en la página actual
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("search");

        searchInput.addEventListener("keyup", function () {
          const searchTerm = this.value.toLowerCase();

          // Accede a la variable de Node.js (miVariable) y asígnala a una variable de JavaScript

          console.log("todos " + todos[0].id);

          var found = false;
          for (var i = 0; i < todos.length; i++) {
            //console.log("contador['id'] " + todos[i].id + " " + searchTerm);
            if ((todos[i].login.toLowerCase()).includes(searchTerm)) {
              found = true;
              break;
            }

          }
          if (found) {
            var pagina = (i / 10) + 1;
            console.log("Página: " + parseInt(pagina));
            location.href = "/gestor-usuarios?page=" + parseInt(pagina);
            //row.style.display = "";
          } else {
            //row.style.display = "none";
          }

        });
      });
    </script>

  </body>